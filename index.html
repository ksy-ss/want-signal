<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Signal Project</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --main-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f8f9fa;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: #333; height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        /* ê³µí†µ í—¤ë”/ìŠ¤íƒ€ì¼ */
        .header { padding: 40px 25px 20px; text-align: left; }
        h1 { margin: 0; font-size: 26px; line-height: 1.4; color: var(--main-color); word-break: keep-all; }
        h1 span { color: var(--accent-color); font-weight: 800; }
        
        /* í™”ë©´ ì „í™˜ìš© ì„¹ì…˜ë“¤ */
        .screen { display: none; padding: 25px; flex: 1; flex-direction: column; animation: fadeIn 0.3s ease; }
        .screen.active { display: flex; }
        
        /* 1. í™ˆ í™”ë©´ (í‚¤ì›Œë“œ êµ¬ë¦„) */
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .tag-btn { background: #f1f3f5; border: none; padding: 8px 16px; border-radius: 20px; color: #555; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .tag-btn:hover { background: var(--accent-color); color: white; }
        
        .main-actions { margin-top: auto; margin-bottom: 40px; display: flex; flex-direction: column; gap: 15px; }
        .btn-primary { background: var(--main-color); color: white; border: none; padding: 18px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-secondary { background: #f1f3f5; color: #555; border: none; padding: 18px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; }

        /* 2. ì…ë ¥ í™”ë©´ */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: #666; font-size: 14px; }
        select, input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; box-sizing: border-box; outline: none; -webkit-appearance: none; }
        select:focus, input:focus { border-color: var(--accent-color); }

        /* 3. ìŠ¤ìº”/ë¡œë”© í™”ë©´ (ë ˆì´ë” íš¨ê³¼) */
        .scan-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .radar { position: relative; width: 120px; height: 120px; background: var(--accent-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; margin-bottom: 30px; }
        .radar::before, .radar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border-radius: 50%; border: 2px solid var(--accent-color); animation: pulse 2s infinite; opacity: 0; }
        .radar::after { animation-delay: 0.6s; }
        .scan-text { font-size: 18px; color: var(--main-color); font-weight: bold; margin-top: 20px; }

        /* 4. ê²°ê³¼ í™”ë©´ */
        .result-circle { width: 140px; height: 140px; border: 4px solid var(--main-color); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 30px; position: relative; }
        .result-count { font-size: 48px; font-weight: 800; color: var(--main-color); line-height: 1; }
        .result-label { font-size: 13px; color: #777; margin-top: 5px; }
        
        .chat-card { background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%); color: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(63, 43, 150, 0.3); }
        .chat-card.empty { background: #eee; color: #777; box-shadow: none; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .chat-title { font-weight: bold; font-size: 18px; }
        .chat-info { font-size: 12px; opacity: 0.9; margin-top: 5px; }
        .chat-badge { background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 10px; font-size: 11px; }

        /* 5. í†µê³„ í™”ë©´ */
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2.5); opacity: 0; } }

        /* ìœ í‹¸ */
        .back-btn { background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="screen-home" class="screen active">
            <div class="header">
                <h1 id="mainTitle"></h1>
            </div>
            <div style="padding: 0 25px;">
                <div class="tag-cloud" id="tagCloud">
                    </div>
            </div>
            <div class="main-actions" style="padding: 0 25px;">
                <button class="btn-primary" id="startBtn" onclick="goToInput()">
                    <i class="fas fa-pen"></i> <span id="inputBtnText">ê¸°ë¡í•˜ê¸°</span>
                </button>
                <button class="btn-secondary" id="statsBtn" onclick="goToStats()">
                    <i class="fas fa-chart-bar"></i> <span id="statsBtnText">ì „ì²´ ì§€ë„ ë³´ê¸°</span>
                </button>
            </div>
        </div>

        <div id="screen-input" class="screen">
            <div style="padding-bottom: 20px;">
                <button class="back-btn" onclick="goBack('home')"><i class="fas fa-arrow-left"></i></button>
                <h2>ì •ë³´ ì…ë ¥</h2>
            </div>
            
            <div class="form-group">
                <label id="keywordLabel">í‚¤ì›Œë“œ</label>
                <input type="text" id="keyword" placeholder="">
            </div>
            <div class="form-group">
                <label id="typeLabel">ìœ í˜•</label>
                <select id="typeSelect"></select>
            </div>
            <div class="form-group">
                <label id="budgetLabel">ì˜ˆì‚°</label>
                <select id="budgetSelect"></select>
            </div>
            <div class="form-group">
                <label id="timeLabel">ì‹œê°„</label>
                <select id="timeSelect"></select>
            </div>

            <button class="btn-primary" id="submitBtn" onclick="sendSignal()" style="margin-top: auto;">
                <span id="submitBtnText">ì†¡ì¶œí•˜ê¸°</span>
            </button>
        </div>

        <div id="screen-scan" class="screen">
            <div class="scan-container">
                <div class="radar"><i class="fas fa-satellite-dish"></i></div>
                <div class="scan-text">ì£¼ë³€ ì‹ í˜¸ íƒìƒ‰ ì¤‘...</div>
                <p style="color:#999; font-size:13px; margin-top:10px;">ë°˜ê²½ 1km ì´ë‚´ì˜ ê³µê°ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <div style="padding-bottom: 20px;">
                <button class="back-btn" onclick="goBack('home')"><i class="fas fa-times"></i></button>
                <h2 style="text-align: center;">ë¶„ì„ ê²°ê³¼</h2>
            </div>

            <div class="result-circle">
                <div class="result-label">ê´€ì‹¬ìˆëŠ” ì´ì›ƒ</div>
                <div class="result-count" id="matchCount">0</div>
                <div class="result-label" style="font-size: 11px; margin-top: 5px;">ì˜¤í”ˆ ì±„íŒ…ë°© <span id="chatCount">0</span></div>
            </div>

            <div style="text-align: center; margin-bottom: 20px; font-size: 14px; color: #555;">
                ë§¤ì¹­ ì„±ê³µ! ëŒ€í™”ì— ì°¸ì—¬í•´ë³´ì„¸ìš”.
            </div>

            <div id="successCard" class="chat-card" style="display:none;" onclick="openChatLink()">
                <div class="chat-header">
                    <span class="chat-title"><i class="fas fa-comments"></i> ëŒ€í™”ë°© ì…ì¥ (1)</span>
                    <span class="chat-badge"><i class="fas fa-map-marker-alt"></i> 0m</span>
                </div>
                <div class="chat-info" id="resultSummary"></div>
                <div class="chat-info" style="text-align: right; margin-top: 10px; font-weight: bold;">
                    23ì‹œê°„ 59ë¶„ ë‚¨ìŒ
                </div>
            </div>

            <div id="emptyCard" class="chat-card empty" style="display:none;">
                <div class="chat-header">
                    <span class="chat-title">ì•„ì§ ì˜¤í”ˆëœ ë°©ì€ ì—†ë„¤ìš”.</span>
                </div>
                <p style="font-size: 13px;">ê°€ì¥ ë¨¼ì € ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
            </div>

            <button class="btn-secondary" onclick="goBack('home')" style="margin-top: auto;">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>

        <div id="screen-stats" class="screen">
            <div style="padding-bottom: 20px;">
                <button class="back-btn" onclick="goBack('home')"><i class="fas fa-arrow-left"></i></button>
                <h2 id="statTitle">íŠ¸ë Œë“œ</h2>
            </div>
            <h4 id="chartTitle1" style="margin-bottom: 10px;"></h4>
            <div class="chart-container">
                <canvas id="typeChart"></canvas>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, query, limitToLast, get, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ============================================================
        // [ì¤‘ìš”] ì‚¬ì¥ë‹˜ì˜ Firebase ì„¤ì •ê°’ (ê·¸ëŒ€ë¡œ ìœ ì§€!)
        // ============================================================
         const firebaseConfig = {
    apiKey: "AIzaSyB6WjGUEn0fEg_k4Yk15bhzAFDoo7RcqWg",
    authDomain: "want-log-v2.firebaseapp.com",
    databaseURL: "https://want-log-v2-default-rtdb.firebaseio.com",
    projectId: "want-log-v2",
    storageBucket: "want-log-v2.firebasestorage.app",
    messagingSenderId: "142800647324",
    appId: "1:142800647324:web:e3100ec7b4daa8467ae959",
    measurementId: "G-HZ4HBQH697"
  };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ============================================================
        // APP CONFIG (ì—¬ê¸°ë¥¼ êµì²´í•˜ë©´ 5ê°œ ëŒ€ë¦¬ì  ì™„ì„±)
        // ============================================================
        
        /* [ì˜ˆì‹œ] ìš•êµ¬ ì§€ë„ (ê¸°ë³¸ ì„¤ì •) */
        const APP_CONFIG = {
    appName: "desire_map_basic", 
    colors: {
        main: "#2980b9",    // ì˜¤ì…˜ ë¸”ë£¨ (ì‹ ë¢°/í¬ë§)
        accent: "#e74c3c",  // ë ˆë“œ (ìš•ë§/ê°•ë ¬í•¨)
        bg: "#ecf0f1"       // ì¿¨ í™”ì´íŠ¸
    },
    text: {
        mainTitle: "ë‹¹ì‹ ì˜ ëª¨ë“  ìš•êµ¬,<br><span>ìš•êµ¬ ì§€ë„</span>ì— ê¸°ë¡í•˜ì„¸ìš”.",
        keywordLabel: "ë¬´ì—‡ì„ ì›í•˜ì‹œë‚˜ìš”?",
        keywordPlace: "ex. ì¹˜í‚¨, ë§¥ë¶ í”„ë¡œ, ì´ì§, íœ´ê°€, ë¡œë˜",
        typeLabel: "ìš•êµ¬ì˜ ì¢…ë¥˜",
        budgetLabel: "í•„ìš” ë¹„ìš©",
        timeLabel: "ì›í•˜ëŠ” ì‹œê¸°",
        submitBtn: "ì§€ë„ì— ì¢Œí‘œ ì°ê¸°",
        inputBtn: "ìš•êµ¬ ê¸°ë¡í•˜ê¸°",
        statsBtn: "ğŸ“Š ì „ì²´ ì§€ë„ ë³´ê¸°",
        statTitle: "ì‚¬ëŒë“¤ì˜ ì‹¤ì‹œê°„<br><span>ìš•ë§ íŠ¸ë Œë“œ</span>",
        chartTitle1: "ğŸ”¥ ê°€ì¥ ë§ì´ ì›í•˜ëŠ” ê²ƒ Top 5"
    },
    options: {
        type: [
            { val: "food", label: "ğŸ” ì‹ìš• (ë§›ì§‘/ë°°ë‹¬)" },
            { val: "item", label: "ğŸ ë¬¼ìš• (ì‡¼í•‘/ì¥ë¹„)" },
            { val: "experience", label: "âœˆï¸ ê²½í—˜ (ì—¬í–‰/ë¬¸í™”)" },
            { val: "goal", label: "ğŸ† ì„±ì·¨ (ê³µë¶€/ì´ì§/ìš´ë™)" }
        ],
        budget: [
            { val: "small", label: "ì†Œì†Œí•˜ê²Œ (3ë§Œì› ì´í•˜)" },
            { val: "medium", label: "ì ë‹¹íˆ (10ë§Œì› ëŒ€)" },
            { val: "big", label: "í° ë§˜ ë¨¹ê³  (50ë§Œì› â†‘)" },
            { val: "dream", label: "ìƒìƒ ê·¸ ì´ìƒ (ê°€ê²©ë¯¸ì •)" }
        ],
        time: [
            { val: "now", label: "ì§€ê¸ˆ ë‹¹ì¥ (Urgent)" },
            { val: "week", label: "ì´ë²ˆ ì£¼ ë‚´ë¡œ" },
            { val: "month", label: "ì´ë²ˆ ë‹¬ ì•ˆì—" },
            { val: "bucket", label: "ì–¸ì  ê°€ëŠ” (ë²„í‚·ë¦¬ìŠ¤íŠ¸)" }
        ]
    }
};

        // ============================================================
        // UI ë¡œì§ (í™”ë©´ ì „í™˜ ë° ë°ì´í„° ì²˜ë¦¬)
        // ============================================================

        // ì´ˆê¸°í™”
        document.documentElement.style.setProperty('--main-color', APP_CONFIG.colors.main);
        document.documentElement.style.setProperty('--accent-color', APP_CONFIG.colors.accent);
        document.documentElement.style.setProperty('--bg-color', APP_CONFIG.colors.bg);
        
        // í…ìŠ¤íŠ¸ ì ìš©
        document.getElementById('mainTitle').innerHTML = APP_CONFIG.text.mainTitle;
        document.getElementById('inputBtnText').innerText = APP_CONFIG.text.inputBtn;
        document.getElementById('statsBtnText').innerText = APP_CONFIG.text.statsBtn;
        document.getElementById('keywordLabel').innerText = APP_CONFIG.text.keywordLabel;
        document.getElementById('keyword').placeholder = APP_CONFIG.text.keywordPlace;
        document.getElementById('typeLabel').innerText = APP_CONFIG.text.typeLabel;
        document.getElementById('budgetLabel').innerText = APP_CONFIG.text.budgetLabel;
        document.getElementById('timeLabel').innerText = APP_CONFIG.text.timeLabel;
        document.getElementById('submitBtnText').innerText = APP_CONFIG.text.submitBtn;
        document.getElementById('statTitle').innerText = APP_CONFIG.text.statTitle;
        document.getElementById('chartTitle1').innerText = APP_CONFIG.text.chartTitle1;

        // íƒœê·¸ êµ¬ë¦„ ìƒì„±
        const tagCloud = document.getElementById('tagCloud');
        APP_CONFIG.tags.forEach(tag => {
            const btn = document.createElement('button');
            btn.className = 'tag-btn';
            btn.innerText = tag;
            btn.onclick = () => {
                document.getElementById('keyword').value = tag;
                goToInput();
            };
            tagCloud.appendChild(btn);
        });

        // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì±„ìš°ê¸°
        function fillSelect(id, list) {
            const el = document.getElementById(id);
            el.innerHTML = "";
            list.forEach(opt => {
                let option = document.createElement('option');
                option.value = opt.val;
                option.text = opt.label;
                el.appendChild(option);
            });
        }
        fillSelect('typeSelect', APP_CONFIG.options.type);
        fillSelect('budgetSelect', APP_CONFIG.options.budget);
        fillSelect('timeSelect', APP_CONFIG.options.time);

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜
        window.showScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');
        }

        window.goToInput = function() { showScreen('input'); }
        window.goBack = function(target) { showScreen(target); }
        window.goToStats = function() { showScreen('stats'); loadStats(); }

        // ì‹ í˜¸ ë³´ë‚´ê¸° (í•µì‹¬ ë¡œì§)
        window.sendSignal = function() {
            const keyword = document.getElementById('keyword').value;
            if(!keyword) { alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }

            const typeLabel = APP_CONFIG.options.type.find(o => o.val === document.getElementById('typeSelect').value).label;
            const budgetLabel = APP_CONFIG.options.budget.find(o => o.val === document.getElementById('budgetSelect').value).label;
            
            const data = {
                keyword: keyword,
                type: document.getElementById('typeSelect').value,
                budget: document.getElementById('budgetSelect').value,
                time: document.getElementById('timeSelect').value,
                timestamp: new Date().toISOString()
            };

            // 1. ìŠ¤ìº” í™”ë©´ìœ¼ë¡œ ì´ë™ (ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘)
            showScreen('scan');

            // 2. Firebase ì €ì¥
            push(ref(db, APP_CONFIG.appName), data).then(() => {
                // 3. ë§¤ì¹­ ë°ì´í„° ê²€ìƒ‰ (3ì´ˆ ë”œë ˆì´ë¡œ ìŠ¤ìº” íš¨ê³¼ ì—°ì¶œ)
                setTimeout(() => {
                    findMatches(keyword, typeLabel, budgetLabel);
                }, 2500);
            });
        };

        // ë§¤ì¹­ ì°¾ê¸° ë° ê²°ê³¼ í‘œì‹œ
        function findMatches(myKeyword, myType, myBudget) {
            // ìµœê·¼ ë°ì´í„° ì¡°íšŒí•´ì„œ ê°™ì€ í‚¤ì›Œë“œ ì¹´ìš´íŠ¸ (ê°„ë‹¨í•œ ë¡œì§)
            const recentPosts = query(ref(db, APP_CONFIG.appName), limitToLast(50));
            
            get(recentPosts).then((snapshot) => {
                let count = 0;
                if (snapshot.exists()) {
                    const val = snapshot.val();
                    Object.values(val).forEach(item => {
                        if (item.keyword && item.keyword.includes(myKeyword)) {
                            count++;
                        }
                    });
                }
                
                // ë‚˜ ìì‹  ì œì™¸ (ë°ì´í„°ê°€ ë°©ê¸ˆ ë“¤ì–´ê°”ìœ¼ë¯€ë¡œ ìµœì†Œ 1ê°œëŠ” ìˆìŒ)
                // ë§Œì•½ ë‚˜ í˜¼ìë¼ë©´ 0ì´ ì•„ë‹ˆë¼ 1ë¡œ í‘œì‹œí•˜ê±°ë‚˜ ë¡œì§ ì¡°ì • (ì—¬ê¸°ì„  ë‹¨ìˆœí™”)
                const neighborCount = count > 1 ? count - 1 : 0; 
                
                // ê²°ê³¼ í™”ë©´ ë Œë”ë§
                document.getElementById('matchCount').innerText = neighborCount;
                
                if (neighborCount > 0) {
                    // ë§¤ì¹­ ì„±ê³µ
                    document.getElementById('chatCount').innerText = "1";
                    document.getElementById('successCard').style.display = 'block';
                    document.getElementById('emptyCard').style.display = 'none';
                    document.getElementById('resultSummary').innerText = `${myKeyword} Â· ${myBudget}`;
                    // ë°°ê²½ìƒ‰ ë³€ê²½ (ì„±ê³µ ëŠë‚Œ)
                    document.getElementById('successCard').style.background = `linear-gradient(135deg, ${APP_CONFIG.colors.accent} 0%, ${APP_CONFIG.colors.main} 100%)`;
                } else {
                    // ë§¤ì¹­ ì‹¤íŒ¨ (ì•„ì§ ì—†ìŒ)
                    document.getElementById('chatCount').innerText = "0";
                    document.getElementById('successCard').style.display = 'none';
                    document.getElementById('emptyCard').style.display = 'block';
                }

                showScreen('result');
            });
        }

        // ì˜¤í”ˆì±„íŒ…ë°© ì´ë™
        window.openChatLink = function() {
            if(APP_CONFIG.openChatUrl) {
                window.open(APP_CONFIG.openChatUrl, '_blank');
            } else {
                alert("ì•„ì§ ê°œì„¤ëœ ì˜¤í”ˆì±„íŒ…ë°© ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }
        };

        // í†µê³„ ì°¨íŠ¸ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
        let chartInstance = null;
        function loadStats() {
            const recentPosts = query(ref(db, APP_CONFIG.appName), limitToLast(100));
            onValue(recentPosts, (snapshot) => {
                const data = snapshot.val();
                if(!data) return;
                const typeCounts = {};
                Object.values(data).forEach(item => {
                    const labelObj = APP_CONFIG.options.type.find(opt => opt.val === item.type);
                    const label = labelObj ? labelObj.label : item.type;
                    typeCounts[label] = (typeCounts[label] || 0) + 1;
                });
                drawChart(typeCounts);
            });
        }

        function drawChart(counts) {
            const ctx = document.getElementById('typeChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: [APP_CONFIG.colors.main, APP_CONFIG.colors.accent, '#95a5a6', '#bdc3c7'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
    </script>
</body>
</html>
