<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WANT Service</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
      /* --- [ë™ì  í…Œë§ˆ ì ìš©ì„ ìœ„í•œ CSS ë³€ìˆ˜] --- */
      :root {
        --main-color: #6200ea;   /* ì•± ì„¤ì •ì— ë”°ë¼ ë°”ë€œ */
        --accent-color: #ffd700; /* ì•± ì„¤ì •ì— ë”°ë¼ ë°”ë€œ */
        --bg-color: #f8f5ff;     /* ì•± ì„¤ì •ì— ë”°ë¼ ë°”ë€œ */
        --text-color: #333;
      }

      /* --- ê³µí†µ ìŠ¤íƒ€ì¼ --- */
      body { margin:0; padding:0; font-family:'Pretendard', sans-serif; background:#fff; color:var(--text-color); overflow-y:auto; }
      .container { max-width:450px; margin:0 auto; padding:20px; min-height:100vh; display:flex; flex-direction:column; position: relative; }
      .view { display:none; flex-direction:column; animation: fadeIn 0.3s ease-in-out; }
      .view.active { display:flex; }
      
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      
      /* íƒ€ì´í‹€ & í—¤ë” */
      h1 { font-size:24px; font-weight:700; margin:40px 0 20px 0; line-height:1.4; word-break: keep-all; }
      h1 span { color:var(--main-color); }
      
      /* ì…ë ¥ í¼ */
      .label { font-weight:700; margin-bottom:8px; display:block; font-size:14px; color:var(--text-color); margin-top: 15px; }
      .input-field { width:100%; padding:12px; font-size:16px; border:1px solid #ddd; border-radius:8px; outline:none; background:#fff; box-sizing:border-box; transition:0.3s; }
      .input-field:focus { border-color:var(--main-color); box-shadow: 0 0 0 2px rgba(98, 0, 234, 0.1); }
      .detail-row { display: flex; gap: 10px; margin-bottom: 5px; }
      .detail-col { flex: 1; }

      /* ë²„íŠ¼ */
      button { width:100%; padding:18px; font-size:16px; font-weight:700; border:none; border-radius:12px; cursor:pointer; margin-top:10px; transition: 0.2s; }
      .btn-primary { background-color:var(--main-color); color:white; margin-top: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
      .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
      .btn-text { background-color:transparent; color:#999; margin-top:20px; }
      .btn-stats { background-color:var(--bg-color); color:var(--main-color); margin-top:15px; font-size:14px; font-weight: 600; }

      /* íƒœê·¸ êµ¬ë¦„ */
      #cloud-area { margin-bottom:30px; display:flex; flex-wrap:wrap; gap:10px; justify-content: flex-start; }
      .tag { background:var(--bg-color); padding:10px 16px; border-radius:24px; font-size:15px; color:var(--main-color); cursor:pointer; font-weight: 500; transition:0.2s; border: 1px solid transparent; }
      .tag:hover { border-color:var(--main-color); background:white; }

      /* ê²°ê³¼ í™”ë©´ UI */
      .circle-container { position: relative; width: 160px; height: 160px; margin: 30px auto; display: flex; align-items: center; justify-content: center; }
      .circle { 
        width: 100%; height: 100%; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; 
        font-weight: 900; background: white; transition: all 0.5s ease;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #eee;
      }
      .count-group { text-align: center; }
      .count-label { font-size: 11px; color: #888; font-weight: 400; margin-bottom: 2px; }
      .count-num { font-size: 36px; line-height: 1; color: var(--main-color); }
      .divider { width: 30px; height: 1px; background: #ddd; margin: 8px auto; }
      .room-stat { font-size: 13px; color: #555; font-weight: 700; }
      .room-stat span { color: var(--main-color); }

      /* ì• ë‹ˆë©”ì´ì…˜ ë° ìƒíƒœ */
      .circle.scanning { border: 4px solid #eee; color: #999; }
      .circle.scanning::after {
        content: ''; position: absolute; inset: -5px; border-radius: 50%; border: 4px solid transparent;
        border-top-color: var(--main-color); border-right-color: var(--main-color); animation: spin 1.5s linear infinite;
      }
      .circle.result { border: 6px solid var(--main-color); background: var(--bg-color); }
      @keyframes spin { 100% { transform: rotate(360deg); } }

      /* ë¦¬ìŠ¤íŠ¸ & ì°¨íŠ¸ */
      .chart-container { margin-bottom: 30px; padding: 15px; border: 1px solid #eee; border-radius: 12px; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
      .chart-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; color: var(--main-color); text-align: center; }
      
      .chat-btn-yellow {
        display: block; width: 100%; padding: 15px; margin-bottom: 10px;
        background: linear-gradient(135deg, var(--accent-color), #fff9c4); 
        color: #3c1e1e; border-radius: 12px; text-decoration: none; box-sizing: border-box;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative; transition: transform 0.2s;
      }
      .chat-btn-yellow:hover { transform: translateY(-2px); }
      .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
      .dist-badge { background: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
      .chat-info-sub { font-size: 12px; color: #555; }
      .timer-badge { position: absolute; bottom: 15px; right: 15px; background: var(--main-color); color: #fff; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
      .stat-info { text-align: center; font-size: 11px; color: #999; margin-top: -20px; margin-bottom: 20px; }
    </style>
  </head>
  <body>
    <div class="container">
      
      <div id="view-home" class="view active">
        <h1 id="ui-main-title">ë¡œë”©ì¤‘...</h1>
        <div id="cloud-area"><div style="text-align:center;color:#999;width:100%;margin-top:20px;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
        
        <button id="ui-btn-input" class="btn-primary" onclick="goInput('')">ì…ë ¥í•˜ê¸°</button>
        <button id="ui-btn-stats" class="btn-stats" onclick="loadStats()">í†µê³„ ë³´ê¸°</button> 
        <button class="btn-text" onclick="loadDataFromFirebase()">ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <div id="view-input" class="view">
        <button class="btn-text" style="padding:0; margin:0 0 10px 0; text-align:left; width:auto;" onclick="goHome()">â† ëŒì•„ê°€ê¸°</button>
        
        <label id="ui-label-keyword" class="label">í‚¤ì›Œë“œ</label>
        <input type="text" id="input-keyword" class="input-field" placeholder="">
        
        <label id="ui-label-type" class="label">ë°©ì‹</label>
        <select id="input-type" class="input-field"></select>

        <div class="detail-row">
            <div class="detail-col">
                <label id="ui-label-budget" class="label">ë¹„ìš©</label>
                <select id="input-budget" class="input-field"></select>
            </div>
            <div class="detail-col">
                <label id="ui-label-time" class="label">ì‹œê°„</label>
                <select id="input-time" class="input-field"></select>
            </div>
        </div>

        <label class="label">ì˜¤í”ˆì¹´í†¡/ì—°ë½ì²˜ (ì„ íƒ)</label>
        <input type="text" id="input-link" class="input-field" placeholder="https://open.kakao.com/...">
        <label class="label">ì´ë©”ì¼ (ì„ íƒ)</label>
        <input type="email" id="input-email" class="input-field" placeholder="ë§¤ì¹­ ì•Œë¦¼ìš©">
        
        <button id="ui-btn-submit" class="btn-primary" onclick="requestLocationAndSubmit()">ì‹ í˜¸ ë³´ë‚´ê¸°</button>
        <div style="text-align:center; font-size:11px; color:#999; margin-top:10px;">* ê±°ë¦¬ ê³„ì‚°ì„ ìœ„í•´ ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.</div>
        <div style="height:50px;"></div>
      </div>

      <div id="view-result" class="view">
        <h1>ë¶„ì„ ê²°ê³¼</h1>
        <div class="circle-container">
            <div id="result-circle" class="circle scanning"><span style="font-size:20px;">SCAN</span></div>
        </div>
        <div class="stat-info">* ìµœê·¼ 3ì‹œê°„ ë‚´ ì…ë ¥ ê¸°ì¤€</div>
        <p id="result-msg" style="text-align:center; color:#555; font-weight:bold; margin-bottom:5px;">íƒìƒ‰ ì¤‘...</p>
        <div id="chat-list-area"></div>
        <button class="btn-primary" onclick="goHome()">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
      </div>

      <div id="view-stats" class="view">
         <button class="btn-text" style="padding:0; margin:0 0 20px 0; text-align:left; width:auto;" onclick="goHome()">â† ëŒì•„ê°€ê¸°</button>
         <h1 id="ui-stat-title">íŠ¸ë Œë“œ ë¶„ì„</h1>
         
         <div class="chart-container">
            <div id="ui-chart-title-1" class="chart-title">ğŸ”¥ í•« í‚¤ì›Œë“œ Top 5</div>
            <canvas id="chart-keyword"></canvas>
         </div>
         <div class="chart-container">
            <div class="chart-title">ğŸ•’ ì‹œê°„ëŒ€ë³„ ì¶”ì´</div>
            <canvas id="chart-time"></canvas>
         </div>
         <div class="chart-container">
            <div class="chart-title">ğŸ§© ì„ í˜¸í•˜ëŠ” ë°©ì‹</div>
            <canvas id="chart-type" style="max-height: 250px;"></canvas>
         </div>
      </div>

    </div>

    <script>
      // -----------------------------------------------------------
      // [1] ì•± ì„¤ì • (ìš•êµ¬ ì§€ë„ Ver)
      // -----------------------------------------------------------
      const APP_CONFIG = {
          appName: "desire_map",
          colors: {
              main: "#2980b9",    // ì˜¤ì…˜ ë¸”ë£¨ (ì‹ ë¢°/í¬ë§)
              accent: "#e74c3c",  // ë ˆë“œ (ê°•ë ¬í•œ ìš•ë§)
              bg: "#ecf0f1"       // ì¿¨ í™”ì´íŠ¸
          },
          text: {
              mainTitle: "ë‹¹ì‹ ì˜ ëª¨ë“  ìš•êµ¬,<br><span>ìš•êµ¬ ì§€ë„</span>ì— ê¸°ë¡í•˜ì„¸ìš”.",
              inputBtn: "ìš•êµ¬ ê¸°ë¡í•˜ê¸°",
              statsBtn: "ğŸ“Š ì „ì²´ ì§€ë„ ë³´ê¸°",
              keywordLabel: "ë¬´ì—‡ì„ ì›í•˜ì‹œë‚˜ìš”?",
              keywordPlace: "ex. ì¹˜í‚¨, ë§¥ë¶ í”„ë¡œ, ì´ì§, íœ´ê°€",
              typeLabel: "ìš•êµ¬ì˜ ì¢…ë¥˜",
              budgetLabel: "í•„ìš” ë¹„ìš©",
              timeLabel: "ì›í•˜ëŠ” ì‹œê¸°",
              submitBtn: "ì§€ë„ì— ì¢Œí‘œ ì°ê¸°",
              statTitle: "ì‚¬ëŒë“¤ì˜ ì‹¤ì‹œê°„<br><span>ìš•ë§ íŠ¸ë Œë“œ</span>",
              chartTitle1: "ğŸ”¥ ê°€ì¥ ë§ì´ ì›í•˜ëŠ” ê²ƒ Top 5"
          },
          options: {
              type: [
                  { val: "food", label: "ğŸ” ì‹ìš• (ë§›ì§‘/ë°°ë‹¬)" },
                  { val: "item", label: "ğŸ ë¬¼ìš• (ì‡¼í•‘/ì¥ë¹„)" },
                  { val: "experience", label: "âœˆï¸ ê²½í—˜ (ì—¬í–‰/ë¬¸í™”)" },
                  { val: "goal", label: "ğŸ† ì„±ì·¨ (ê³µë¶€/ì´ì§/ìš´ë™)" }
              ],
              budget: [
                  { val: "small", label: "ì†Œì†Œí•˜ê²Œ (3ë§Œì› ì´í•˜)" },
                  { val: "medium", label: "ì ë‹¹íˆ (10ë§Œì› ëŒ€)" },
                  { val: "big", label: "í° ë§˜ ë¨¹ê³  (50ë§Œì› â†‘)" },
                  { val: "dream", label: "ìƒìƒ ê·¸ ì´ìƒ (ê°€ê²©ë¯¸ì •)" }
              ],
              time: [
                  { val: "now", label: "ì§€ê¸ˆ ë‹¹ì¥ (Urgent)" },
                  { val: "week", label: "ì´ë²ˆ ì£¼ ë‚´ë¡œ" },
                  { val: "month", label: "ì´ë²ˆ ë‹¬ ì•ˆì—" },
                  { val: "bucket", label: "ì–¸ì  ê°€ëŠ” (ë²„í‚·ë¦¬ìŠ¤íŠ¸)" }
              ]
          }
      };

      // -----------------------------------------------------------
      // [2] Firebase ì´ˆê¸°í™”
      // -----------------------------------------------------------
      const firebaseConfig = {
    apiKey: "AIzaSyB6WjGUEn0fEg_k4Yk15bhzAFDoo7RcqWg",
    authDomain: "want-log-v2.firebaseapp.com",
    databaseURL: "https://want-log-v2-default-rtdb.firebaseio.com",
    projectId: "want-log-v2",
    storageBucket: "want-log-v2.firebasestorage.app",
    messagingSenderId: "142800647324",
    appId: "1:142800647324:web:e3100ec7b4daa8467ae959",
    measurementId: "G-HZ4HBQH697"
  };
      
      // Firebase ì´ˆê¸°í™” (ë²„ì „ 8 ë°©ì‹)
      if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
      }
      const db = firebase.database();
      const appRef = db.ref(APP_CONFIG.appName); 

      // -----------------------------------------------------------
      // [3] ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸° ì‹¤í–‰
      // -----------------------------------------------------------
      var timerInterval = null;
      var myCharts = {};
      
      // ì‹œì‘í•˜ìë§ˆì ì„¤ì • ì ìš© ë° ë°ì´í„° ë¡œë“œ
      window.onload = function() {
          applyAppConfig();
          loadDataFromFirebase();
      };

      // -----------------------------------------------------------
      // [4] ì•± ì„¤ì • ì ìš© í•¨ìˆ˜ (App Factory Core)
      // -----------------------------------------------------------
      function applyAppConfig() {
          // CSS ë³€ìˆ˜ ì„¸íŒ…
          document.documentElement.style.setProperty('--main-color', APP_CONFIG.colors.main);
          document.documentElement.style.setProperty('--accent-color', APP_CONFIG.colors.accent);
          document.documentElement.style.setProperty('--bg-color', APP_CONFIG.colors.bg);

          // í…ìŠ¤íŠ¸ ì„¸íŒ…
          document.getElementById('ui-main-title').innerHTML = APP_CONFIG.text.mainTitle;
          document.getElementById('ui-btn-input').innerText = APP_CONFIG.text.inputBtn;
          document.getElementById('ui-btn-stats').innerText = APP_CONFIG.text.statsBtn;
          
          document.getElementById('ui-label-keyword').innerText = APP_CONFIG.text.keywordLabel;
          document.getElementById('input-keyword').placeholder = APP_CONFIG.text.keywordPlace;
          document.getElementById('ui-label-type').innerText = APP_CONFIG.text.typeLabel;
          document.getElementById('ui-label-budget').innerText = APP_CONFIG.text.budgetLabel;
          document.getElementById('ui-label-time').innerText = APP_CONFIG.text.timeLabel;
          document.getElementById('ui-btn-submit').innerText = APP_CONFIG.text.submitBtn;
          
          document.getElementById('ui-stat-title').innerHTML = APP_CONFIG.text.statTitle;
          document.getElementById('ui-chart-title-1').innerText = APP_CONFIG.text.chartTitle1;

          // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìƒì„±
          fillSelect('input-type', APP_CONFIG.options.type);
          fillSelect('input-budget', APP_CONFIG.options.budget);
          fillSelect('input-time', APP_CONFIG.options.time);
      }

      function fillSelect(id, options) {
          var el = document.getElementById(id);
          el.innerHTML = '';
          options.forEach(opt => {
              var o = document.createElement('option');
              o.value = opt.val;
              o.innerText = opt.label;
              el.appendChild(o);
          });
      }

      // -----------------------------------------------------------
      // [5] Firebase ë°ì´í„° ë¡œì§ (ì½ê¸°/ì“°ê¸°)
      // -----------------------------------------------------------
      
      // A. ì‹¤ì‹œê°„ íŠ¸ë Œë“œ ë¡œë“œ (Client-side Filtering)
      function loadDataFromFirebase() {
          var cloud = document.getElementById('cloud-area');
          cloud.innerHTML = '<div style="text-align:center;color:#999;width:100%;margin-top:20px;">ë°ì´í„° ìŠ¤ìº” ì¤‘...</div>';

          // ìµœê·¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹œê°„ìˆœ ì •ë ¬)
          appRef.orderByChild('timestamp').limitToLast(100).once('value').then((snapshot) => {
              cloud.innerHTML = '';
              const data = snapshot.val();
              if(!data) {
                  cloud.innerHTML='<div style="text-align:center; width:100%; color:#ccc;">ì•„ì§ ë°ì´í„°ê°€ ì—†ì–´ìš”!</div>';
                  return;
              }

              // ë°ì´í„° ê°€ê³µ (ì—­ìˆœ ì •ë ¬ ë° ì¤‘ë³µ í‚¤ì›Œë“œ ì œê±°)
              const items = Object.values(data).reverse();
              const uniqueSet = new Set();
              
              items.forEach(item => {
                  if(item.keyword && !uniqueSet.has(item.keyword) && uniqueSet.size < 20) {
                      uniqueSet.add(item.keyword);
                      var t = document.createElement('div'); 
                      t.className='tag'; 
                      t.innerText=item.keyword;
                      t.onclick=function(){ goInput(item.keyword); }; 
                      cloud.appendChild(t);
                  }
              });
          });
      }

      // B. ë°ì´í„° ì „ì†¡ (ì§ì ‘ ì“°ê¸°)
      function submitData(lat, lng) {
          document.getElementById('result-msg').innerText = "ì‹¤ì‹œê°„ ì„œë²„ì— ì ‘ì† ì¤‘...";
          
          const now = new Date().getTime();
          const payload = {
              timestamp: now,
              keyword: document.getElementById('input-keyword').value,
              type: document.getElementById('input-type').value,
              budget: document.getElementById('input-budget').value,
              validTime: document.getElementById('input-time').value,
              link: document.getElementById('input-link').value,
              email: document.getElementById('input-email').value,
              lat: lat, 
              lng: lng,
              id: 'WANT-' + now + '-' + Math.floor(Math.random()*1000)
          };

          // Firebaseì— ì €ì¥
          appRef.push(payload).then(() => {
              console.log("ì €ì¥ ì„±ê³µ");
              // ì €ì¥ í›„ ë°”ë¡œ ë§¤ì¹­ ê²°ê³¼ ê³„ì‚°
              calculateMatching(payload);
          }).catch((error) => {
              alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
              goHome();
          });
      }

      // C. í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë§¤ì¹­ ë¡œì§ (ì„œë²„ ì—†ì´ ê³„ì‚°)
      function calculateMatching(myData) {
          document.getElementById('result-msg').innerText = "ë§¤ì¹­ ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...";
          
          appRef.orderByChild('timestamp').limitToLast(200).once('value').then((snapshot) => {
              const allData = snapshot.val();
              const matches = [];
              let interestCount = 0;
              const now = new Date().getTime();
              const STATS_WINDOW_MS = 3 * 60 * 60 * 1000; // 3ì‹œê°„

              if(allData) {
                  Object.values(allData).forEach(row => {
                      // 1. ê´€ì‹¬ì ìˆ˜ ì¹´ìš´íŠ¸ (3ì‹œê°„ ë‚´ + í‚¤ì›Œë“œ ì¼ì¹˜)
                      if(row.keyword === myData.keyword && (now - row.timestamp) < STATS_WINDOW_MS) {
                          interestCount++;
                      }

                      // 2. ì±„íŒ…ë°© ë§¤ì¹­ (ë§í¬ ìˆìŒ + ë‚´êº¼ ì•„ë‹˜ + í‚¤ì›Œë“œ ì¼ì¹˜)
                      if(row.keyword === myData.keyword && row.link && row.id !== myData.id) {
                          // ìœ íš¨ì‹œê°„ ì²´í¬
                          var durationMap = {"1h": 1, "3h": 3, "6h": 6, "12h": 12};
                          var hours = durationMap[row.validTime] || 24;
                          var expireTime = row.timestamp + (hours * 60 * 60 * 1000);

                          if(now < expireTime) {
                              var dist = getDistanceFromLatLonInKm(myData.lat, myData.lng, row.lat, row.lng);
                              matches.push({
                                  link: row.link,
                                  expireTime: expireTime,
                                  type: row.type,
                                  budget: row.budget,
                                  distance: dist
                              });
                          }
                      }
                  });
              }
              
              renderResults({ interestCount: interestCount, activeRooms: matches });
          });
      }

      // D. í†µê³„ ë°ì´í„° ê³„ì‚°
      function loadStats() {
          showView('view-stats');
          // ìµœê·¼ 300ê°œ ë°ì´í„°ë¡œ í†µê³„ ëƒ„
          appRef.orderByChild('timestamp').limitToLast(300).once('value').then((snapshot) => {
              const data = snapshot.val();
              if(!data) return;

              const items = Object.values(data);
              var keywordCounts = {};
              var timeCounts = { "Morning(ì•„ì¹¨)":0, "Lunch(ì ì‹¬)":0, "Afternoon(ì˜¤í›„)":0, "Evening(ì €ë…)":0, "Night(ì‹¬ì•¼)":0 };
              var typeCounts = { "together":0, "empathy":0, "exchange":0, "transfer":0 };

              items.forEach(item => {
                  // í‚¤ì›Œë“œ
                  if(item.keyword) keywordCounts[item.keyword] = (keywordCounts[item.keyword] || 0) + 1;
                  
                  // íƒ€ì…
                  if(item.type && typeCounts.hasOwnProperty(item.type)) typeCounts[item.type]++;

                  // ì‹œê°„ëŒ€ (íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ì—­ì‚°)
                  var hour = new Date(item.timestamp).getHours();
                  var timeBlock = "";
                  if (hour >= 6 && hour < 11) timeBlock = "Morning(ì•„ì¹¨)";
                  else if (hour >= 11 && hour < 14) timeBlock = "Lunch(ì ì‹¬)";
                  else if (hour >= 14 && hour < 18) timeBlock = "Afternoon(ì˜¤í›„)";
                  else if (hour >= 18 && hour < 22) timeBlock = "Evening(ì €ë…)";
                  else timeBlock = "Night(ì‹¬ì•¼)";
                  if(timeBlock) timeCounts[timeBlock]++;
              });

              // Top 5 ì •ë ¬
              var sortedKeywords = Object.entries(keywordCounts).sort((a,b) => b[1]-a[1]).slice(0,5);

              renderCharts({
                  topKeywords: sortedKeywords,
                  timeStats: timeCounts,
                  typeStats: typeCounts
              });
          });
      }

      // -----------------------------------------------------------
      // [6] ìœ í‹¸ë¦¬í‹° ë° UI í•¨ìˆ˜
      // -----------------------------------------------------------
      
      // ê±°ë¦¬ ê³„ì‚° (Haversine) - JSë¡œ ì´ì‹ë¨
      function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
          if (!lat1 || !lon1 || !lat2 || !lon2) return null;
          var R = 6371; 
          var dLat = deg2rad(lat2-lat1);
          var dLon = deg2rad(lon2-lon1); 
          var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
          var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          return R * c;
      }
      function deg2rad(deg) { return deg * (Math.PI/180); }

      // ë·° ì „í™˜
      function showView(id) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
      }
      function goHome() {
        if(timerInterval) clearInterval(timerInterval);
        document.getElementById('input-keyword').value = '';
        document.getElementById('input-link').value = ''; 
        document.getElementById('chat-list-area').innerHTML = '';
        var c = document.getElementById('result-circle');
        c.className = 'circle scanning'; 
        c.innerHTML = '<span style="font-size:20px;">SCAN</span>';
        document.getElementById('result-msg').innerText = '';
        showView('view-home');
        loadDataFromFirebase();
      }
      function goInput(txt) {
        if(txt) document.getElementById('input-keyword').value = txt;
        showView('view-input');
      }

      // ìœ„ì¹˜ ìš”ì²­
      function requestLocationAndSubmit() {
        var k = document.getElementById('input-keyword').value;
        if(!k) { alert('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
        showView('view-result');
        document.getElementById('result-msg').innerText = "ìœ„ì¹˜ ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...";
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) { submitData(position.coords.latitude, position.coords.longitude); },
            function(error) { console.log("ìœ„ì¹˜ ì‹¤íŒ¨", error); submitData(null, null); }
          );
        } else { submitData(null, null); }
      }

      // ê²°ê³¼ ë Œë”ë§
      function renderResults(res) {
          var c = document.getElementById('result-circle');
          var msg = document.getElementById('result-msg');
          c.className = 'circle result';
          c.innerHTML = `
            <div class="count-group">
                <div class="count-label">ê´€ì‹¬ìˆëŠ” ì´ì›ƒ</div>
                <div class="count-num">${res.interestCount}</div>
            </div>
            <div class="divider"></div>
            <div class="room-stat">ì˜¤í”ˆ ì±„íŒ…ë°© <span>${res.activeRooms.length}</span></div>
          `;
          if (res.activeRooms.length > 0) {
              msg.innerText = "ë§¤ì¹­ ì„±ê³µ! ëŒ€í™”ì— ì°¸ì—¬í•´ë³´ì„¸ìš”.";
              createChatButtons(res.activeRooms);
          } else {
              msg.innerText = "ì•„ì§ ì˜¤í”ˆëœ ë°©ì€ ì—†ë„¤ìš”.";
          }
      }

      // ì±„íŒ…ë°© ë²„íŠ¼ ìƒì„±
      function createChatButtons(matches) {
          var listArea = document.getElementById('chat-list-area');
          listArea.innerHTML = '';
          matches.forEach(function(match, index) {
              var btn = document.createElement('a');
              btn.className = 'chat-btn-yellow';
              btn.href = match.link;
              btn.target = "_blank";
              
              var distText = "ê±°ë¦¬ëª¨ë¦„";
              if (match.distance !== null) {
                  if (match.distance < 1) distText = Math.round(match.distance * 1000) + "m";
                  else distText = match.distance.toFixed(1) + "km";
              }
              
              // ì˜µì…˜ ë¼ë²¨ ì°¾ê¸°
              var typeLabel = APP_CONFIG.options.type.find(o => o.val === match.type)?.label || match.type;
              var budgetLabel = APP_CONFIG.options.budget.find(o => o.val === match.budget)?.label || match.budget;

              btn.innerHTML = `
                <div class="chat-header">
                    <span style="font-weight:bold;">ğŸ’¬ ëŒ€í™”ë°© ì…ì¥ (${index+1})</span>
                    <span class="dist-badge">ğŸ“ ${distText}</span>
                </div>
                <div class="chat-info-sub">${typeLabel} Â· ${budgetLabel}</div>
                <span id="timer-${index}" class="timer-badge">ê³„ì‚°ì¤‘...</span>
              `;
              listArea.appendChild(btn);
          });

          if(timerInterval) clearInterval(timerInterval);
          timerInterval = setInterval(function() {
              var now = new Date().getTime();
              matches.forEach(function(match, index) {
                  var badge = document.getElementById(`timer-${index}`);
                  if(badge) {
                      var diff = match.expireTime - now;
                      if (diff <= 0) {
                          badge.innerText = "ì¢…ë£Œë¨";
                          badge.style.background = "#999";
                      } else {
                          var h = Math.floor(diff / (1000 * 60 * 60));
                          var m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                          var s = Math.floor((diff % (1000 * 60)) / 1000);
                          badge.innerText = (h>0 ? h+"ì‹œê°„ " : "") + m + "ë¶„ " + s + "ì´ˆ";
                      }
                  }
              });
          }, 1000);
      }

      // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
      function renderCharts(data) {
        if(myCharts.keyword) myCharts.keyword.destroy();
        if(myCharts.time) myCharts.time.destroy();
        if(myCharts.type) myCharts.type.destroy();

        var ctxKw = document.getElementById('chart-keyword').getContext('2d');
        myCharts.keyword = new Chart(ctxKw, {
            type: 'bar',
            data: {
                labels: data.topKeywords.map(i => i[0]),
                datasets: [{
                    data: data.topKeywords.map(i => i[1]),
                    backgroundColor: APP_CONFIG.colors.main,
                    borderRadius: 8
                }]
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision:0 }, grid: { display:false } }, x: { grid: { display:false } } } }
        });

        var ctxTime = document.getElementById('chart-time').getContext('2d');
        var timeLabels = ["Morning(ì•„ì¹¨)", "Lunch(ì ì‹¬)", "Afternoon(ì˜¤í›„)", "Evening(ì €ë…)", "Night(ì‹¬ì•¼)"];
        var simpleTimeLabels = ["ì•„ì¹¨", "ì ì‹¬", "ì˜¤í›„", "ì €ë…", "ì‹¬ì•¼"];
        myCharts.time = new Chart(ctxTime, {
            type: 'line',
            data: {
                labels: simpleTimeLabels,
                datasets: [{
                    data: timeLabels.map(k => data.timeStats[k] || 0),
                    borderColor: APP_CONFIG.colors.accent,
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    fill: true, tension: 0.4
                }]
            },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision:0 } } } }
        });

        var ctxType = document.getElementById('chart-type').getContext('2d');
        var typeLabels = APP_CONFIG.options.type.map(o => o.label);
        var typeVals = APP_CONFIG.options.type.map(o => data.typeStats[o.val] || 0);

        myCharts.type = new Chart(ctxType, {
            type: 'doughnut',
            data: {
                labels: typeLabels,
                datasets: [{
                    data: typeVals,
                    backgroundColor: ['#7c4dff', '#b47cff', '#ffd700', '#ff4081'],
                    borderWidth: 2, borderColor: '#fff'
                }]
            },
            options: { plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, usePointStyle: true } } }, cutout: '60%' }
        });
      }
    </script>
  </body>
</html>
